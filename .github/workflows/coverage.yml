name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
      
      - name: Run tests with coverage
        run: |
          deno test --coverage=coverage src/**/*.test.ts --allow-read --allow-net --allow-env --unstable
          deno coverage coverage --lcov --output=coverage.lcov
      
      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(deno coverage coverage 2>&1 | grep "All files" | awk '{print $(NF-1)}')
          if [ -z "$COVERAGE" ]; then
            COVERAGE="0"
          fi
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
      
      - name: Create badge directory
        if: github.ref == 'refs/heads/main'
        run: mkdir -p .github/badges
      
      - name: Create coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          COVERAGE="${{ steps.coverage.outputs.percentage }}"
          COLOR="red"
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then COLOR="brightgreen"; fi
          if (( $(echo "$COVERAGE < 80 && $COVERAGE >= 60" | bc -l) )); then COLOR="yellow"; fi
          if (( $(echo "$COVERAGE < 60" | bc -l) )); then COLOR="orange"; fi
          echo "{\"schemaVersion\":1,\"label\":\"coverage\",\"message\":\"${COVERAGE}%\",\"color\":\"${COLOR}\"}" > .github/badges/coverage.json
      
      - name: Commit badge
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/badges/coverage.json
          git diff --staged --quiet || git commit -m "Update coverage badge [skip ci]"
          git push
